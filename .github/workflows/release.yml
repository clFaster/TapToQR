name: "Release TapToQR"

on:
  workflow_dispatch:
    inputs:
      release-type:
        type: choice
        description: Which type of release to create?
        required: true
        default: patch
        options:
          - patch
          - minor
          - major

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  # Get the Current Version and Bump it depending on the release-type input
  update-version:
    name: "Update TapToQR Version"
    runs-on: ubuntu-latest
    permissions: write-all
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

#      - name: Ensure branch is main
#        if: github.ref != 'refs/heads/main'
#        run: |
#          text="Publish a new version can only be done from the main branch."
#          echo "::error title=Wrong Branch::$text"
#          exit 1

      - name: Read current version
        run: |
          echo "Current version: ${{ vars.VERSION }}"

      - name: Bump version
        id: bump_version
        run: |
          # Retrieve the increment type from the GitHub Actions input
          increment="${{ inputs.release-type }}"
          
          # Split the VERSION variable into its major, minor, and patch components
          IFS='.' read -r -a parts <<< "${{ vars.VERSION }}"
          
          # Check if the VERSION variable was split correctly
          if [ "${#parts[@]}" -ne 3 ]; then
          echo "Invalid version format"
          exit 1
          fi
          
          major=${parts[0]}
          minor=${parts[1]}
          patch=${parts[2]}
          
          # Increment the appropriate version component
          if [ "$increment" = "major" ]; then
          major=$((major + 1))
          minor=0
          patch=0
          elif [ "$increment" = "minor" ]; then
          minor=$((minor + 1))
          patch=0
          elif [ "$increment" = "patch" ]; then
          patch=$((patch + 1))
          else
          echo "Invalid increment type"
          exit 1
          fi
          
          # Construct the new version string
          new_version="$major.$minor.$patch"
          
          # Output the new version
          echo "New version: $new_version"
          
          # Set the output variable for GitHub Actions
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

      - name: Update version var
        id: write_version
        env:
          GITHUB_TOKEN: ${{ secrets.VAR_UPDATE_GITHUB }}
        run: |
          gh variable set VERSION --body "${{ steps.bump_version.outputs.new_version }}"

  build:
    uses: ./.github/workflows/build.yml
    with:
      VERSION: ${{ needs.update-version.outputs.new_version }}
    needs:
      [
        update-version
      ]

  release-github:
    runs-on: ubuntu-latest
    name: "Create TapToQR Github Release"
    permissions: write-all
    needs:
      [
        build,
        update-version
      ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4

#      - name: Create Release
#        working-directory: './TapToQR-addon'
#        env:
#          GH_TOKEN: ${{github.token}}
#        run: |
#          echo "Creating release v${{needs.update-version.outputs.new_version}}"
#          gh release create v${{needs.update-version.outputs.new_version}} --generate-notes
#          gh release upload v${{needs.update-version.outputs.new_version}} TapToQR-${{needs.update-version.outputs.new_version}}.zip

  release-firefox:
    runs-on: ubuntu-latest
    name: "Create TapToQR Firefox Release"
    needs:
      [
        build,
        update-version
      ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4

#      - uses: wdzeng/firefox-addon@1c933bcfc899dad45719bc23ec8c607d51bf8c06
#        name: "Upload to Firefox Addon Store"
#        with:
#          addon-guid: "taptoqr@moritzreis.dev"
#          xpi-path: TapToQR-addon/TapToQR-${{needs.update-version.outputs.new_version}}.zip
#          self-hosted: false
#          jwt-issuer: ${{ secrets.FIREFOX_JWT_ISSUER }}
#          jwt-secret: ${{ secrets.FIREFOX_JWT_SECRET }}

  release-chrome:
    runs-on: ubuntu-latest
    name: "Create TapToQR Chrome Release"
    needs:
      [
        build,
        update-version
      ]

    env:
      EXTENSION_ID: "ommdikomjapdndpedljobeecepeopjmp"
      CLIENT_ID: ${{ secrets.CI_GOOGLE_CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CI_GOOGLE_CLIENT_SECRET }}
      REFRESH_TOKEN: ${{ secrets.CI_GOOGLE_REFRESH_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4

      - name: "Setup Google Webstore CLI"
        run: |
          npm install -g chrome-webstore-upload-cli

#      - name: "Upload to Chrome Webstore"
#        run: |-
#          cd TapToQR-addon
#
#          unzip TapToQR-${{needs.update-version.outputs.new_version}}.zip
#          rm TapToQR-${{needs.update-version.outputs.new_version}}.zip
#
#          chrome-webstore-upload

  release-edge:
    runs-on: ubuntu-latest
    name: "Create TapToQR Edge Release"
    needs:
      [
        build,
        update-version
      ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
